
@{
    ViewBag.Title = "Login";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<script src="~/Scripts/jquery-3.4.1.min.js"></script>

<div class="signup-form ">
    <div class="wrapper-2">
        <div class="form-title">Login !</div>
        <div class="form">
            <form>


                <p class="content-item">
                    <label>
                        email address
                        <input id="username" type="text" placeholder="Trantam@gmail.com" name="email">
                    </label>
                </p>

                <p class="content-item">

                    <label>
                        password
                        <input id="password" type="password" placeholder="*****" name="psw">
                    </label>
                </p>



            </form>
            <button id="login" class="signup" >login </button>
            <a href="@Url.Action("registration","Login")" class="login">sign up</a>
        </div>
    </div>

</div>

<script>
    $(document).ready(function () {
        $("#login").click(function () {

            var data = {
                "TenTK": $("#username").val(),
                "MatKhau": $("#password").val(),

            };
            $.ajax({
                url: 'https://localhost:44370/api/v1/account/login',
                type: 'POST',
                data: data,
                error: function (err) {
                    console.log('Error!', err)
                    alert("Đăng nhập thất bại!");
                },
                success: function (data, textStatus, request) {
                    var token = request.getResponseHeader('Authorization').split(' ');
                    localStorage.setItem("token", token[1]);
                    if (parseJwt(token[1]).role == "admin") {
                        sessionStorage.setItem('role', "admin");
                    }
                    else {
                        sessionStorage.setItem('role', "user");
                    }
                    console.log(parseJwt(token[1]));
                    alert("đăng nhập thành công.");
                    window.location = "https://localhost:44370/home/home";
                }
            });
        });
    });
    function parseJwt(token) {
        var base64Url = token.split('.')[1];
        var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        var jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));

        return JSON.parse(jsonPayload);
    };
</script>


